{
  "version": 3,
  "sources": ["../src/main.ts"],
  "sourcesContent": ["/*\n * Created with @iobroker/create-adapter v2.6.5\n */\n\n// The adapter-core module gives you access to the core ioBroker functions\n// you need to create an adapter\nimport * as utils from \"@iobroker/adapter-core\";\n\n// Load your modules here, e.g.:\n// import * as fs from \"fs\";\n//import { client } from \"websocket\";\nimport * as WebSockeClient from \"websocket\";\n\nclass Alphainnotec extends utils.Adapter {\n\tdeclare private ws;\n\tdeclare private connection;\n\tdeclare private items;\n\tdeclare private poller;\n\tdeclare private status;\n\tpublic constructor(options: Partial<utils.AdapterOptions> = {}) {\n\t\tsuper({\n\t\t\t...options,\n\t\t\tname: \"alphainnotec\",\n\t\t});\n\n\t\tthis.ws = new WebSockeClient.client();\n\t\tthis.connection;\n\t\tthis.poller;\n\t\tthis.status;\n\t\tthis.items = {};\n\n\t\tthis.on(\"ready\", this.onReady.bind(this));\n\t\tthis.on(\"stateChange\", this.onStateChange.bind(this));\n\t\t// this.on(\"objectChange\", this.onObjectChange.bind(this));\n\t\tthis.on(\"unload\", this.onUnload.bind(this));\n\t}\n\n\tprivate wsConnect(): void {\n\t\tthis.log.debug(`Connection to Heatpump on ${this.config.ipaddress}:${this.config.port}`);\n\t\tthis.ws.connect(`ws://${this.config.ipaddress}:${this.config.port}`, \"Lux_WS\");\n\t}\n\n\tasync wsCheckStatus(): Promise<void> {\n\t\tif (this.connection && this.connection.connected) {\n\t\t\tthis.setState(\"info.connection\", { val: true, ack: true });\n\t\t} else {\n\t\t\tthis.setState(\"info.connection\", { val: false, ack: true });\n\t\t\tthis.wsReconnect(\"Lost Connection\");\n\t\t}\n\t}\n\n\tprivate wsReconnect(error: string): void {\n\t\tthis.log.error(\"Connect failed: \" + error.toString());\n\t\tthis.log.info(\"Trying to reconnect...\");\n\t\tthis.wsConnect();\n\t}\n\n\tasync wsHandleError(error: string): Promise<void> {\n\t\tthis.log.error(\"got an error: \" + error.toString());\n\t}\n\n\tasync wsOnClose(): Promise<void> {\n\t\tthis.log.error(\"Websocket closed\");\n\t\t// nothin yes\n\t}\n\n\tasync wsHandleConnection(connection: any): Promise<void> {\n\t\tif (connection.connected) {\n\t\t\tthis.connection = connection;\n\t\t\tthis.log.info(\"Successfully connected to heatpump\");\n\n\t\t\t// handle connection events\n\t\t\tthis.connection.on(\"error\", this.wsHandleError.bind(this));\n\t\t\tthis.connection.on(\"close\", this.wsOnClose.bind(this));\n\t\t\tthis.connection.on(\"message\", this.wsParseMessage.bind(this));\n\t\t}\n\t}\n\n\tasync wsPollData(): Promise<void> {\n\t\tthis.log.debug(\"Polling Data\");\n\t\tif (this.connection && this.connection.connected) {\n\t\t\tthis.connection.send(`LOGIN;${this.config.password}`);\n\t\t}\n\t}\n\n\tasync SetDatapoint(name: string, value: any): Promise<void> {\n\t\tlet type: ioBroker.CommonType = \"mixed\";\n\t\tlet unit = \"\";\n\t\tlet val;\n\t\tif (/^-?\\s*[\\d.-]+\\s*[^\\d]+$/.test(value) && !/^\\d+:/.test(value)) {\n\t\t\tconst matches = value.match(/^(-?\\s*[\\d.-]+)\\s*([^\\d]+)$/);\n\t\t\tval = parseFloat(matches[1]);\n\t\t\tunit = matches[2];\n\t\t\ttype = \"mixed\";\n\t\t} else {\n\t\t\tval = value;\n\t\t}\n\t\tawait this.setObjectNotExistsAsync(`${name}`, {\n\t\t\ttype: \"state\",\n\t\t\tcommon: {\n\t\t\t\tname: `${name}`,\n\t\t\t\ttype: `${type}`,\n\t\t\t\trole: \"state\",\n\t\t\t\tread: true,\n\t\t\t\twrite: false,\n\t\t\t\tunit: unit,\n\t\t\t},\n\t\t\tnative: {},\n\t\t});\n\t\tthis.setState(`${name}`, { val: val, ack: true });\n\t}\n\n\tasync wsParseMessage(message: any): Promise<void> {\n\t\t//this.log.debug(message.utf8Data.toString());\n\t\tlet json;\n\t\ttry {\n\t\t\tjson = JSON.parse(message.utf8Data.toString());\n\t\t\tif (json.type == \"Navigation\") {\n\t\t\t\tthis.items = json.items;\n\t\t\t\tfor (const item of json.items) {\n\t\t\t\t\tthis.log.debug(`Polling ${item.name}`);\n\t\t\t\t\tthis.connection.send(`GET;${item.id}`);\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (json.type == \"Content\") {\n\t\t\t\tif (typeof json.name !== \"undefined\") {\n\t\t\t\t\tconst topfolder = json.name.replace(/\\./g, \"\");\n\t\t\t\t\tfor (const item of json.items) {\n\t\t\t\t\t\tconst subname = item.name.replace(/\\./g, \"\");\n\t\t\t\t\t\tthis.log.debug(`Found Section: ${topfolder}.${subname}`);\n\t\t\t\t\t\tif (Array.isArray(item.items)) {\n\t\t\t\t\t\t\tfor (const datapoint of item.items) {\n\t\t\t\t\t\t\t\tconst dpName = `${topfolder}.${subname}.${datapoint.name.replace(/\\./g, \"\")}`;\n\t\t\t\t\t\t\t\tif (Array.isArray(datapoint.items)) {\n\t\t\t\t\t\t\t\t\tfor (const subdatapoint of datapoint.items) {\n\t\t\t\t\t\t\t\t\t\tconst subdpName = `${dpName}.${subdatapoint.name.replace(/\\./g, \"\")}`;\n\t\t\t\t\t\t\t\t\t\tawait this.SetDatapoint(subdpName, subdatapoint.value);\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\tawait this.SetDatapoint(dpName, datapoint.value);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (err) {\n\t\t\treturn;\n\t\t}\n\t}\n\n\t/**\n\t * Is called when databases are connected and adapter received configuration.\n\t */\n\tprivate async onReady(): Promise<void> {\n\t\t// Initialize your adapter here\n\n\t\t// Reset the connection indicator during startup\n\t\tthis.setState(\"info.connection\", false, true);\n\n\t\tthis.ws.on(\"connect\", this.wsHandleConnection.bind(this));\n\t\tthis.wsConnect();\n\t\tthis.poller = setInterval(this.wsPollData.bind(this), this.config.polltime * 1000);\n\t\tthis.status = setInterval(this.wsCheckStatus.bind(this), 1000);\n\n\t\t// The adapters config (in the instance object everything under the attribute \"native\") is accessible via\n\t\t// this.config:\n\t\t//this.log.info(\"config option1: \" + this.config.option1);\n\t\t//this.log.info(\"config option2: \" + this.config.option2);\n\n\t\t/*\n\t\tFor every state in the system there has to be also an object of type state\n\t\tHere a simple template for a boolean variable named \"testVariable\"\n\t\tBecause every adapter instance uses its own unique namespace variable names can't collide with other adapters variables\n\n\t\tawait this.setObjectNotExistsAsync(\"testVariable\", {\n\t\t\ttype: \"state\",\n\t\t\tcommon: {\n\t\t\t\tname: \"testVariable\",\n\t\t\t\ttype: \"boolean\",\n\t\t\t\trole: \"indicator\",\n\t\t\t\tread: true,\n\t\t\t\twrite: true,\n\t\t\t},\n\t\t\tnative: {},\n\t\t});\n\t\t*/\n\n\t\t// In order to get state updates, you need to subscribe to them. The following line adds a subscription for our variable we have created above.\n\t\t//this.subscribeStates(\"testVariable\");\n\t\t// You can also add a subscription for multiple states. The following line watches all states starting with \"lights.\"\n\t\t// this.subscribeStates(\"lights.*\");\n\t\t// Or, if you really must, you can also watch all states. Don't do this if you don't need to. Otherwise this will cause a lot of unnecessary load on the system:\n\t\t// this.subscribeStates(\"*\");\n\n\t\t/*\n\t\t\tsetState examples\n\t\t\tyou will notice that each setState will cause the stateChange event to fire (because of above subscribeStates cmd)\n\t\t*/\n\t\t// the variable testVariable is set to true as command (ack=false)\n\t\t//await this.setStateAsync(\"testVariable\", true);\n\n\t\t// same thing, but the value is flagged \"ack\"\n\t\t// ack should be always set to true if the value is received from or acknowledged from the target system\n\t\t//await this.setStateAsync(\"testVariable\", { val: true, ack: true });\n\n\t\t// same thing, but the state is deleted after 30s (getState will return null afterwards)\n\t\t//await this.setStateAsync(\"testVariable\", { val: true, ack: true, expire: 30 });\n\n\t\t// examples for the checkPassword/checkGroup functions\n\t\t//let result = await this.checkPasswordAsync(\"admin\", \"iobroker\");\n\t\t//this.log.info(\"check user admin pw iobroker: \" + result);\n\n\t\t//result = await this.checkGroupAsync(\"admin\", \"admin\");\n\t\t//this.log.info(\"check group user admin group admin: \" + result);\n\t}\n\n\t/**\n\t * Is called when adapter shuts down - callback has to be called under any circumstances!\n\t */\n\tprivate onUnload(callback: () => void): void {\n\t\ttry {\n\t\t\t// Here you must clear all timeouts or intervals that may still be active\n\t\t\t// clearTimeout(timeout1);\n\t\t\t// clearTimeout(timeout2);\n\t\t\t// ...\n\t\t\t// clearInterval(interval1);\n\t\t\tclearInterval(this.poller);\n\t\t\tclearInterval(this.status);\n\n\t\t\tcallback();\n\t\t} catch (e) {\n\t\t\tcallback();\n\t\t}\n\t}\n\n\t// If you need to react to object changes, uncomment the following block and the corresponding line in the constructor.\n\t// You also need to subscribe to the objects with `this.subscribeObjects`, similar to `this.subscribeStates`.\n\t// /**\n\t//  * Is called if a subscribed object changes\n\t//  */\n\t// private onObjectChange(id: string, obj: ioBroker.Object | null | undefined): void {\n\t// \tif (obj) {\n\t// \t\t// The object was changed\n\t// \t\tthis.log.info(`object ${id} changed: ${JSON.stringify(obj)}`);\n\t// \t} else {\n\t// \t\t// The object was deleted\n\t// \t\tthis.log.info(`object ${id} deleted`);\n\t// \t}\n\t// }\n\n\t/**\n\t * Is called if a subscribed state changes\n\t */\n\tprivate onStateChange(id: string, state: ioBroker.State | null | undefined): void {\n\t\tif (state) {\n\t\t\t// The state was changed\n\t\t\tthis.log.info(`state ${id} changed: ${state.val} (ack = ${state.ack})`);\n\t\t} else {\n\t\t\t// The state was deleted\n\t\t\tthis.log.info(`state ${id} deleted`);\n\t\t}\n\t}\n}\n\nif (require.main !== module) {\n\t// Export the constructor in compact mode\n\tmodule.exports = (options: Partial<utils.AdapterOptions> | undefined) => new Alphainnotec(options);\n} else {\n\t// otherwise start the instance directly\n\t(() => new Alphainnotec())();\n}\n"],
  "mappings": "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",
  "names": []
}
